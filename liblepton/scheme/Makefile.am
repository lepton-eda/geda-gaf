scmdatadir = $(LEPTONDATADIR)/scheme
nobase_dist_scmdata_DATA = \
	geda.scm \
	geda-deprecated-config.scm \
	color-map.scm \
	geda/object.scm \
	geda/page.scm \
	geda/attrib.scm \
	geda/deprecated.scm \
	geda/os.scm \
	geda/config.scm \
	geda/log.scm \
	geda/library.scm \
	lepton/attrib.scm \
	lepton/config.scm \
	lepton/file-system.scm \
	lepton/library.scm \
	lepton/library/component.scm \
	lepton/log.scm \
	lepton/log-rotate.scm \
	lepton/object.scm \
	lepton/os.scm \
	lepton/page.scm \
	lepton/rc.scm \
	lepton/repl.scm \
	lepton/version.scm \
	lepton/legacy-config/keylist.scm \
	lepton/legacy-config.scm \
	netlist.scm \
	netlist/attrib/compare.scm \
	netlist/attrib/refdes.scm \
	netlist/backend-getopt.scm \
	netlist/config.scm \
	netlist/deprecated.scm \
	netlist/duplicate.scm \
	netlist/error.scm \
	netlist/hierarchy.scm \
	netlist/mode.scm \
	netlist/net.scm \
	netlist/option.scm \
	netlist/package-pin.scm \
	netlist/package.scm \
	netlist/partlist.scm \
	netlist/partlist/common.scm \
	netlist/port.scm \
	netlist/schematic-component.scm \
	netlist/schematic-connection.scm \
	netlist/schematic-port.scm \
	netlist/schematic.scm \
	netlist/schematic/toplevel.scm \
	netlist/subschematic.scm \
	netlist/subschematic-connection.scm \
	netlist/verbose.scm \
	symbol/blame.scm \
	symbol/check.scm \
	symbol/check/alignment.scm \
	symbol/check/arc.scm \
	symbol/check/attrib.scm \
	symbol/check/box.scm \
	symbol/check/bus.scm \
	symbol/check/circle.scm \
	symbol/check/component.scm \
	symbol/check/connection.scm \
	symbol/check/duplicate.scm \
	symbol/check/entity-pin.scm \
	symbol/check/forbidden.scm \
	symbol/check/line.scm \
	symbol/check/log.scm \
	symbol/check/net.scm \
	symbol/check/net-attrib.scm \
	symbol/check/obsolete.scm \
	symbol/check/path.scm \
	symbol/check/picture.scm \
	symbol/check/pin.scm \
	symbol/check/pin-attrib.scm \
	symbol/check/primitive.scm \
	symbol/check/slot.scm \
	symbol/check/text.scm \
	symcheck/check.scm \
	symcheck/option.scm \
	symcheck/report.scm

nobase_scmdata_DATA = lepton/core/gettext.scm

TESTS = \
	unit-tests/test-geda-attrib-basic.scm \
	unit-tests/test-geda-config.scm \
	unit-tests/test-geda-deprecated.scm \
	unit-tests/test-geda-object-arc.scm \
	unit-tests/test-geda-object-bounds.scm \
	unit-tests/test-geda-object-box.scm \
	unit-tests/test-geda-object-circle.scm \
	unit-tests/test-geda-object-component.scm \
	unit-tests/test-geda-object-connections.scm \
	unit-tests/test-geda-object-copy.scm \
	unit-tests/test-geda-object-embedded.scm \
	unit-tests/test-geda-object-fill.scm \
	unit-tests/test-geda-object-line.scm \
	unit-tests/test-geda-object-path.scm \
	unit-tests/test-geda-object-picture.scm \
	unit-tests/test-geda-object-selectable.scm \
	unit-tests/test-geda-object-stroke.scm \
	unit-tests/test-geda-object-text.scm \
	unit-tests/test-geda-object-transform.scm \
	unit-tests/test-geda-os-basic.scm \
	unit-tests/test-geda-os-expand-env-variables.scm \
	unit-tests/test-geda-page-basic.scm \
	unit-tests/test-geda-page-dirty.scm \
	unit-tests/test-geda-page-parse-embed-no-component.scm \
	unit-tests/test-geda-page-parse-garbage-attrib.scm \
	unit-tests/test-geda-page-parse-line-endings.scm \
	unit-tests/test-geda-page-parse-ordering.scm \
	unit-tests/test-geda-page-parse-unterminated-attrib.scm \
	unit-tests/test-geda-page-string.scm \
	unit-tests/test-geda-promotable-attribs.scm \
	unit-tests/test-lepton-attrib-basic.scm \
	unit-tests/test-lepton-config.scm \
	unit-tests/test-lepton-file-system.scm \
	unit-tests/test-lepton-library-component.scm \
	unit-tests/test-lepton-library-source-library-contents.scm \
	unit-tests/test-lepton-object-arc.scm \
	unit-tests/test-lepton-object-bounds.scm \
	unit-tests/test-lepton-object-box.scm \
	unit-tests/test-lepton-object-circle.scm \
	unit-tests/test-lepton-object-component.scm \
	unit-tests/test-lepton-object-connections.scm \
	unit-tests/test-lepton-object-copy.scm \
	unit-tests/test-lepton-object-embedded.scm \
	unit-tests/test-lepton-object-fill.scm \
	unit-tests/test-lepton-object-line.scm \
	unit-tests/test-lepton-object-path.scm \
	unit-tests/test-lepton-object-picture.scm \
	unit-tests/test-lepton-object-selectable.scm \
	unit-tests/test-lepton-object-stroke.scm \
	unit-tests/test-lepton-object-text.scm \
	unit-tests/test-lepton-object-transform.scm \
	unit-tests/test-lepton-os-basic.scm \
	unit-tests/test-lepton-os-expand-env-variables.scm \
	unit-tests/test-lepton-page-basic.scm \
	unit-tests/test-lepton-page-dirty.scm \
	unit-tests/test-lepton-page-parse-embed-no-component.scm \
	unit-tests/test-lepton-page-parse-garbage-attrib.scm \
	unit-tests/test-lepton-page-parse-line-endings.scm \
	unit-tests/test-lepton-page-parse-ordering.scm \
	unit-tests/test-lepton-page-parse-unterminated-attrib.scm \
	unit-tests/test-lepton-page-string.scm \
	unit-tests/test-lepton-promotable-attribs.scm \
	unit-tests/test-lepton-rc-build-path.scm \
	unit-tests/test-netlist-attrib.scm \
	unit-tests/test-netlist-load-path.scm \
	unit-tests/test-netlist-partlist.scm

TEST_EXTENSIONS = .scm
# $(srcdir) and $(builddir) are added here and not in
# AM_SCM_LOG_FLAGS below because guile must know where to find
# netlist modules before it runs tests
SCM_LOG_DRIVER = $(GUILE) \
	-L $(abs_top_srcdir)/liblepton/scheme \
	-L $(abs_top_builddir)/liblepton/scheme \
	-L $(abs_top_srcdir)/netlist/scheme \
	-L $(abs_top_builddir)/netlist/scheme \
	-L $(abs_top_srcdir)/symcheck/scheme \
	-L $(abs_top_builddir)/symcheck/scheme \
	--no-auto-compile -e main/with-toplevel -s unit-test.scm

check-am: update-cli-tool

# Unit test support.  The unit tests are run using the geda-batch
# program, with config loading disabled (-q) so that user config
# already on the system can't interfere with the test process.
CLI_SHELL = $(top_builddir)/cli/lepton-cli --no-rcfiles shell
TEST_EXTENSIONS = .scm
SCM_LOG_COMPILER = $(CLI_SHELL)
AM_SCM_LOG_FLAGS = -L $(srcdir) -L $(builddir)

dist_noinst_DATA = lepton/core/gettext.scm.in unit-test.scm $(TESTS)

lepton/core/gettext.scm: $(srcdir)/lepton/core/gettext.scm.in Makefile
	@domain=$(LIBLEPTON_GETTEXT_DOMAIN); \
	$(MKDIR_P) lepton/core; \
	sed -e"s:[@]LIBLEPTON_GETTEXT_DOMAIN@:$$domain:" < $(srcdir)/$@.in > $@.new; \
	if cmp $@ $@.new > /dev/null 2>&1; then \
	  rm $@.new; echo "$@ is unchanged"; \
	else \
	  echo "Recreating $@"; mv $@.new $@; \
	fi

update-cli-tool:
	for d in liblepton/src libleptonrenderer cli; do \
	  (cd $(top_builddir)/$$d && $(MAKE) $(AM_MAKEFLAGS) all-am); \
	done

.PHONY: update-cli-tool

CLEANFILES = lepton/core/gettext.scm unit-tests/dummy.sym unit-tests/dummy.xpm
